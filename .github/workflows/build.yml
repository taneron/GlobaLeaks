name: Build

on: 
  push:
  pull_request:
  workflow_dispatch:
    inputs:
      target_distribution:
        description: 'Target distribution (bookworm, noble, jammy, focal, or all)'
        required: false
        default: bookworm
        type: choice
        options:
          - bookworm
          - noble
          - jammy
          - focal
          - all

# Declare default permissions as read only.
permissions: read-all

env:
  TARGET_DISTRIBUTION: ${{ github.event.inputs.target_distribution || 'bookworm' }}

jobs:
  build_and_test:
    runs-on: "ubuntu-latest"
    strategy:
      matrix:
        distribution: ${{ fromJson(github.event.inputs.target_distribution == 'all' && '["bookworm", "noble", "jammy", "focal"]' || format('["{0}"]', github.event.inputs.target_distribution || 'bookworm')) }}
    
    steps:
      - name: Check out repository code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0
        with:
          node-version: 'lts/*'

      - name: Install build dependencies
        run: |
          sudo apt-get update -q
          sudo apt-get install -y git curl wget ca-certificates gnupg lsb-release
          sudo apt-get install -y build-essential debhelper devscripts
          sudo apt-get install -y brotli dh-apparmor
          sudo apt-get install -y dh-python pybuild-plugin-pyproject python3-all python3-setuptools python3-sphinx
          sudo apt-get install -y docker-compose
          
          # Install Chrome for Cypress
          wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
          echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
          sudo apt-get update -q
          sudo apt-get install -y google-chrome-stable

      - name: Build Debian package using build.sh
        run: |
          echo "Building for distribution: ${{ matrix.distribution }}"
          
          # Set up git configuration
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"
          
          # Create a temporary parent directory structure that build.sh expects
          mkdir -p ../temp-build
          cd ../temp-build
          
          # Create the expected directory structure for local builds
          mkdir -p globaleaks-whistleblowing-software
          
          # Copy the source code into the expected location
          cp -r ../globaleaks-whistleblowing-software/* globaleaks-whistleblowing-software/
          cp -r ../globaleaks-whistleblowing-software/.git globaleaks-whistleblowing-software/ 2>/dev/null || true
          
          # Initialize git repository in the copied location if needed
          cd globaleaks-whistleblowing-software
          if [ ! -d .git ]; then
            git init
            git add .
            git commit -m "Initial commit for build"
          fi
          
          # Run the build script with local environment flag
          ./scripts/build.sh -d ${{ matrix.distribution }} -n -l
          
          # Copy build results back to original location
          cp -r build ../globaleaks-whistleblowing-software/
          
          # Return to original directory
          cd ../globaleaks-whistleblowing-software
          
          # Show what was built
          echo "Build completed. Looking for .deb files:"
          find build/ -name "*.deb" -ls || echo "No .deb files found"

      - name: Create Docker testing environment
        run: |
          # Copy the built .deb file to docker directory
          mkdir -p docker/deb
          find build/ -name "*.deb" -exec cp {} docker/deb/ \;
          
          # Copy the install script to docker directory
          cp scripts/install.sh docker/
          
          # Create a test Dockerfile for this distribution
          ./.github/workflows/scripts/create_test_dockerfile.sh ${{ matrix.distribution }}

      - name: Build test Docker image
        run: |
          cd docker
          docker build -f Dockerfile.test -t globaleaks-test:${{ matrix.distribution }} .

      - name: Start Docker container for testing
        run: |
          cd docker
          
          # Create docker-compose.test.yml
          cat > docker-compose.test.yml << EOF
          version: '3.8'
          
          services:
            globaleaks:
              image: globaleaks-test:${{ matrix.distribution }}
              ports:
                - "8080:8080"
                - "8443:8443"
              container_name: globaleaks-test-${{ matrix.distribution }}
              healthcheck:
                test: ["CMD", "curl", "-k", "-f", "https://localhost:8443"]
                interval: 10s
                timeout: 5s
                retries: 12
                start_period: 30s
          EOF
          
          docker-compose -f docker-compose.test.yml up -d
          
          # Wait for service to be ready
          echo "Waiting for GlobaLeaks to start..."
          timeout 120 bash -c 'until curl -k https://localhost:8443 2>/dev/null; do echo "Waiting..."; sleep 5; done'
          echo "GlobaLeaks is ready!"
          
          # Show container logs for debugging
          docker-compose -f docker-compose.test.yml logs

      - name: Install Cypress dependencies
        run: |
          cd client
          npm install -d

      - name: Run Cypress tests
        run: |
          cd client
          npx cypress run --browser chrome --config baseUrl=https://localhost:8443,chromeWebSecurity=false

      - name: Stop Docker container
        if: always()
        run: |
          cd docker
          docker-compose -f docker-compose.test.yml down || true

      - name: Upload test artifacts
        if: failure()
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3
        with:
          name: cypress-artifacts-${{ matrix.distribution }}
          path: |
            client/cypress/screenshots/
            client/cypress/videos/
