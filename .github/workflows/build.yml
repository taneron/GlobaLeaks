name: Build

on: 
  push:
  pull_request:
  workflow_dispatch:
    inputs:
      target_distribution:
        description: 'Target distribution (bookworm, noble, jammy, focal, or all)'
        required: false
        default: bookworm
        type: choice
        options:
          - bookworm
          - noble
          - jammy
          - focal
          - all

# Declare default permissions as read only.
permissions: read-all

env:
  TARGET_DISTRIBUTION: ${{ github.event.inputs.target_distribution || 'bookworm' }}

jobs:
  build_and_test:
    runs-on: "ubuntu-latest"
    strategy:
      matrix:
        distribution: ${{ fromJson(github.event.inputs.target_distribution == 'all' && '["bookworm", "noble", "jammy", "focal"]' || format('["{0}"]', github.event.inputs.target_distribution || 'bookworm')) }}
    
    steps:
      - name: Check out repository code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - name: Ensure stable branch is available
        run: |
          git config remote.origin.url "https://github.com/globaleaks/globaleaks-whistleblowing-software.git"
          git fetch origin stable:stable
          
      - name: Setup Node.js
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0
        with:
          node-version: 'lts/*'

      - name: Install build dependencies
        run: |
          sudo apt-get update -q
          sudo apt-get install -y git curl wget ca-certificates gnupg lsb-release
          sudo apt-get install -y build-essential debhelper devscripts
          sudo apt-get install -y brotli dh-apparmor
          sudo apt-get install -y dh-python pybuild-plugin-pyproject python3-all python3-setuptools python3-sphinx
          sudo apt-get install -y docker-compose
          
          # Install Chrome for Cypress
          wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
          echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
          sudo apt-get update -q
          sudo apt-get install -y google-chrome-stable

      - name: Build packages for all distributions
        run: |
          # Get all distributions for this matrix
          if [ "${{ github.event.inputs.target_distribution }}" == "all" ]; then
            distributions=("bookworm" "noble" "jammy" "focal")
          else
            distributions=("${{ matrix.distribution }}")
          fi
          
          echo "Building packages for distributions: ${distributions[*]}"
          
          # Set up git configuration
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"
          
          # Build packages for each distribution
          for dist in "${distributions[@]}"; do
            echo "Building for distribution: $dist"
            
            # Create a temporary parent directory structure that build.sh expects
            mkdir -p ../temp-build-$dist
            cd ../temp-build-$dist
            
            # Create the expected directory structure for local builds
            mkdir -p globaleaks-whistleblowing-software
            
            # Copy the source code into the expected location
            cp -r ../globaleaks-whistleblowing-software/* globaleaks-whistleblowing-software/
            cp -r ../globaleaks-whistleblowing-software/.git globaleaks-whistleblowing-software/ 2>/dev/null || true
            
            # Initialize git repository in the copied location if needed
            cd globaleaks-whistleblowing-software
            if [ ! -d .git ]; then
              git init
              git add .
              git commit -m "Initial commit for build"
            fi
            
            # Run the build script with local environment flag
            ./scripts/build.sh -d $dist -n -l
            
            # Copy build results back to original location with distribution-specific path
            mkdir -p ../../globaleaks-whistleblowing-software/build/$dist
            cp -r build/* ../../globaleaks-whistleblowing-software/build/$dist/
            
            # Return to original directory
            cd ../../globaleaks-whistleblowing-software
            
            # Show what was built
            echo "Build completed for $dist. Looking for .deb files:"
            find build/$dist -name "*.deb" -ls || echo "No .deb files found for $dist"
          done

      - name: Prepare Docker testing environment
        run: |
          # Create docker directory structure for all distributions
          if [ "${{ github.event.inputs.target_distribution }}" == "all" ]; then
            distributions=("bookworm" "noble" "jammy" "focal")
          else
            distributions=("${{ matrix.distribution }}")
          fi
          
          echo "Preparing Docker environment for: ${distributions[*]}"
          
          # Create distribution-specific .deb directories
          for dist in "${distributions[@]}"; do
            mkdir -p docker/deb/$dist
            # Find .deb files in the build directory structure
            deb_files=$(find build/$dist -name "*.deb" -type f)
            if [ -n "$deb_files" ]; then
              echo "Found .deb files for $dist:"
              echo "$deb_files"
              cp $deb_files docker/deb/$dist/
              echo "Copied .deb files for $dist:"
              ls -la docker/deb/$dist/
            else
              echo "No .deb files found for $dist"
              echo "Build directory structure:"
              find build/$dist -type f -name "*.deb" -o -name "*.changes" -o -name "*.buildinfo" | head -20
              exit 1
            fi
          done
          
          # Use the Docker-specific install script
          echo "Using Docker-specific installation script"

      - name: Build and start all Docker containers
        run: |
          cd docker
          
          # Determine distributions and compose profiles
          if [ "${{ github.event.inputs.target_distribution }}" == "all" ]; then
            distributions=("bookworm" "noble" "jammy" "focal")
            profiles="test-bookworm,test-noble,test-jammy,test-focal"
          else
            distributions=("${{ matrix.distribution }}")
            profiles="test-${{ matrix.distribution }}"
          fi
          
          # Build and start containers using enhanced docker-compose.yml with profiles
          echo "Building and starting Docker containers for profiles: $profiles"
          COMPOSE_PROFILES="$profiles" docker-compose up -d --build
          
          echo "Waiting for services to be ready..."
          for dist in "${distributions[@]}"; do
            # Use predefined ports from docker-compose.yml
            case $dist in
              "bookworm") port=8443 ;;
              "noble") port=8444 ;;
              "jammy") port=8445 ;;
              "focal") port=8446 ;;
            esac
            echo "Waiting for $dist on port $port..."
            timeout 120 bash -c "until curl -k https://localhost:$port 2>/dev/null; do echo 'Waiting for $dist...'; sleep 5; done" || {
              echo "Error: $dist service failed to start"
              docker-compose logs "globaleaks-test-$dist"
              exit 1
            }
            echo "‚úÖ $dist is ready on port $port"
          done

      - name: Install Cypress and Lighthouse dependencies efficiently
        run: |
          cd client
          
          # Check Node.js and npm versions
          echo "Node.js version: $(node --version)"
          echo "npm version: $(npm --version)"
          
          # Clear npm cache to avoid any potential issues
          npm cache clean --force || true
          
          # Use existing package.json with efficient installation (without --silent to see errors)
          echo "Installing npm dependencies..."
          npm ci --include=dev || {
            echo "npm ci failed, trying alternative approach..."
            # Fallback: regular npm install with older syntax
            npm install --only=dev || npm install --include=dev
          }
          
          # Verify Cypress installation
          echo "Verifying Cypress installation..."
          npx cypress verify
          echo "Cypress dependencies installed successfully"
          
          # Install Lighthouse globally for CI use
          echo "Installing Lighthouse CLI..."
          npm install -g lighthouse@11.7.1

      - name: Run Cypress tests and Lighthouse audits against all distributions
        run: |
          cd client
          
          if [ "${{ github.event.inputs.target_distribution }}" == "all" ]; then
            distributions=("bookworm" "noble" "jammy" "focal")
          else
            distributions=("${{ matrix.distribution }}")
          fi
          
          # Run tests against each distribution
          test_results=()
          lighthouse_results=()
          
          for dist in "${distributions[@]}"; do
            # Use predefined ports from docker-compose.yml
            case $dist in
              "bookworm") port=8443 ;;
              "noble") port=8444 ;;
              "jammy") port=8445 ;;
              "focal") port=8446 ;;
            esac
            
            echo "üîç Running Lighthouse audits for $dist on port $port..."
            
            # Create lighthouse directory for this distribution
            mkdir -p lighthouse-results/$dist
            
            # Run Lighthouse audit for this distribution
            lighthouse_exit_code=0
            lighthouse https://localhost:$port \
              --chrome-flags="--allow-running-insecure-content --disable-web-security --allow-insecure-localhost --ignore-certificate-errors --ignore-ssl-errors --ignore-certificate-errors-spki-list" \
              --preset=desktop \
              --output=json \
              --output=html \
              --output-path=./lighthouse-results/$dist/lighthouse-report \
              --only-categories=performance,accessibility,best-practices,seo,pwa || lighthouse_exit_code=$?
            
            # Check Lighthouse results and thresholds
            if [ -f "./lighthouse-results/$dist/lighthouse-report.json" ]; then
              # Validate against thresholds
              lighthouse_validation=$(node -e "
                const fs = require('fs');
                const report = JSON.parse(fs.readFileSync('./lighthouse-results/$dist/lighthouse-report.json', 'utf8'));
                
                const thresholds = {
                  performance: 60,
                  accessibility: 85,
                  'best-practices': 80,
                  seo: 95,
                  pwa: 30
                };
                
                let failedChecks = [];
                let scores = {};
                
                Object.entries(thresholds).forEach(([category, threshold]) => {
                  const score = Math.round(report.categories[category].score * 100);
                  scores[category] = score;
                  if (score < threshold) {
                    failedChecks.push(category + ': ' + score + '% (min: ' + threshold + '%)');
                  }
                });
                
                console.log('SCORES:' + JSON.stringify(scores));
                
                if (failedChecks.length > 0) {
                  console.log('FAILED:' + failedChecks.join(', '));
                  process.exit(1);
                } else {
                  console.log('PASSED:All thresholds met');
                }
              " 2>/dev/null)
              
              if echo "$lighthouse_validation" | grep -q "FAILED:"; then
                failed_audits=$(echo "$lighthouse_validation" | grep "FAILED:" | cut -d: -f2-)
                echo "‚ùå Lighthouse audit failed for $dist: $failed_audits"
                lighthouse_results+=("$dist:LIGHTHOUSE_FAIL")
              else
                scores=$(echo "$lighthouse_validation" | grep "SCORES:" | cut -d: -f2-)
                echo "‚úÖ Lighthouse audit passed for $dist: $scores"
                lighthouse_results+=("$dist:LIGHTHOUSE_PASS")
              fi
            else
              echo "‚ùå Lighthouse report not found for $dist"
              lighthouse_results+=("$dist:LIGHTHOUSE_ERROR")
            fi
            
            echo "üß™ Running Cypress tests for $dist on port $port..."
            
            # Run Cypress tests and capture exit code
            if npx cypress run --browser chrome then
              echo "‚úÖ Cypress tests passed for $dist"
              test_results+=("$dist:CYPRESS_PASS")
            else
              echo "‚ùå Cypress tests failed for $dist"
              test_results+=("$dist:CYPRESS_FAIL")
            fi
          done
          
          # Print comprehensive summary
          echo ""
          echo "üèÅ Test Results Summary:"
          echo "========================"
          echo "Cypress Results:"
          for result in "${test_results[@]}"; do
            echo "  $result"
          done
          echo ""
          echo "Lighthouse Results:"
          for result in "${lighthouse_results[@]}"; do
            echo "  $result"
          done
          
          # Check if any tests failed
          failed=false
          if echo "${test_results[@]}" | grep -q "FAIL"; then
            echo ""
            echo "‚ùå Some Cypress tests failed"
            failed=true
          fi
          
          if echo "${lighthouse_results[@]}" | grep -q "FAIL\|ERROR"; then
            echo ""
            echo "‚ùå Some Lighthouse audits failed"
            failed=true
          fi
          
          if [ "$failed" = true ]; then
            exit 1
          else
            echo ""
            echo "‚úÖ All tests and audits passed!"
          fi

      - name: Cleanup Docker containers
        if: always()
        run: |
          cd docker
          echo "Stopping all Docker containers..."
          
          # Stop using the same profiles that were started
          if [ "${{ github.event.inputs.target_distribution }}" == "all" ]; then
            COMPOSE_PROFILES="test-bookworm,test-noble,test-jammy,test-focal" docker-compose down || true
          else
            COMPOSE_PROFILES="test-${{ matrix.distribution }}" docker-compose down || true
          fi
          
          echo "Cleanup completed"

      - name: Upload test and audit artifacts
        if: always()
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3
        with:
          name: test-artifacts-${{ matrix.distribution }}
          path: |
            client/cypress/screenshots/
            client/cypress/videos/
            client/lighthouse-results/
            build/**/*.log
            build/**/*.deb
            docker/docker-compose.yml
          retention-days: 7
