name: Build

on: 
  push:
  pull_request:
  workflow_dispatch:
    inputs:
      target_distribution:
        description: 'Target distribution (bookworm, noble, jammy, focal, or all)'
        required: false
        default: bookworm
        type: choice
        options:
          - bookworm
          - noble
          - jammy
          - focal
          - all

# Declare default permissions as read only.
permissions: read-all

env:
  TARGET_DISTRIBUTION: ${{ github.event.inputs.target_distribution || 'bookworm' }}

jobs:
  build_and_test:
    runs-on: "ubuntu-latest"
    strategy:
      matrix:
        distribution: ${{ fromJson(github.event.inputs.target_distribution == 'all' && '["bookworm", "noble", "jammy", "focal"]' || format('["{0}"]', github.event.inputs.target_distribution || 'bookworm')) }}
    
    steps:
      - name: Check out repository code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0
        with:
          node-version: 'lts/*'

      - name: Install dependencies
        run: |
          sudo apt-get update -q
          sudo apt-get install -y git docker-compose curl
          
          # Install Chrome for Cypress
          wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
          echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
          sudo apt-get update -q
          sudo apt-get install -y google-chrome-stable

      - name: Build Debian package using Docker
        run: |
          echo "Building for distribution: ${{ matrix.distribution }}"
          
          # Create Docker build environment
          mkdir -p docker-build/output
          
          # Create Dockerfile for building
          cat > docker-build/Dockerfile << 'EOF'
          FROM debian:${{ matrix.distribution }}-slim

          # Set environment variables
          ENV DEBIAN_FRONTEND=noninteractive

          # Install build dependencies
          RUN apt-get update -q && \
              apt-get dist-upgrade -y && \
              apt-get install -y git curl wget ca-certificates gnupg lsb-release && \
              apt-get install -y build-essential debhelper devscripts && \
              apt-get install -y brotli dh-apparmor && \
              apt-get install -y dh-python pybuild-plugin-pyproject python3-all python3-setuptools python3-sphinx && \
              curl -fsSL https://deb.nodesource.com/setup_lts.x | bash - && \
              apt-get update && \
              apt-get install -y nodejs && \
              apt-get clean && \
              rm -rf /var/lib/apt/lists/*

          WORKDIR /workspace
          COPY . .
          
          # Prepare build directory
          RUN echo "=== Setting up build directory ===" && \
              mkdir -p build/src && \
              tar --exclude='./build' -cf - . | tar -xf - -C build/src && \
              echo "Build directory created successfully"
          
          # Configure distribution-specific files
          RUN echo "=== Configuring distribution files ===" && \
              cd build/src && \
              rm -f debian/control backend/requirements.txt && \
              if [ "${{ matrix.distribution }}" = "bionic" ]; then echo 10 > debian/compat; else echo 12 > debian/compat; fi && \
              echo "Compat file set: $(cat debian/compat)" && \
              cp debian/controlX/control.${{ matrix.distribution }} debian/control && \
              echo "Control file copied" && \
              cp backend/requirements/requirements-${{ matrix.distribution }}.txt backend/requirements.txt && \
              echo "Requirements file copied" && \
              sed -i "s/stable; urgency=/${{ matrix.distribution }}; urgency=/g" debian/changelog && \
              echo "Changelog updated"
          
          # Build client
          RUN echo "=== Building client ===" && \
              cd build/src/client && \
              echo "Node version: $(node --version)" && \
              echo "NPM version: $(npm --version)" && \
              npm install -d && \
              echo "NPM install completed" && \
              ./node_modules/grunt/bin/grunt build && \
              echo "Client build completed"
          
          # Build Debian package
          RUN echo "=== Building Debian package ===" && \
              cd build/src && \
              echo "Starting debuild..." && \
              debuild -i -us -uc -b && \
              echo "Debuild completed successfully"
          
          CMD ["bash", "-c", "echo 'Finding .deb files...'; find . -name '*.deb' -ls; cp build/*.deb /output/ 2>/dev/null || find . -name '*.deb' -exec cp {} /output/ \\;"]
          EOF
          
          # Build the package inside Docker
          docker build -f docker-build/Dockerfile -t globaleaks-builder:${{ matrix.distribution }} .
          docker run --rm -v "$(pwd)/docker-build/output:/output" globaleaks-builder:${{ matrix.distribution }}
          
          # Show what was built
          echo "Build completed. Contents of output directory:"
          find docker-build/output/ -name "*.deb" -ls || echo "No .deb files found"

      - name: Create Docker testing environment
        run: |
          # Copy the built .deb file to docker directory
          mkdir -p docker/deb
          cp docker-build/output/*.deb docker/deb/ || true
          
          # Copy the install script to docker directory
          cp scripts/install.sh docker/
          
          # Create a test Dockerfile for this distribution
          ./.github/workflows/scripts/create_test_dockerfile.sh ${{ matrix.distribution }}

      - name: Build test Docker image
        run: |
          cd docker
          docker build -f Dockerfile.test -t globaleaks-test:${{ matrix.distribution }} .

      - name: Start Docker container for testing
        run: |
          cd docker
          
          # Create docker-compose.test.yml
          cat > docker-compose.test.yml << EOF
          version: '3.8'
          
          services:
            globaleaks:
              image: globaleaks-test:${{ matrix.distribution }}
              ports:
                - "8080:8080"
                - "8443:8443"
              container_name: globaleaks-test-${{ matrix.distribution }}
              healthcheck:
                test: ["CMD", "curl", "-k", "-f", "https://localhost:8443"]
                interval: 10s
                timeout: 5s
                retries: 12
                start_period: 30s
          EOF
          
          docker-compose -f docker-compose.test.yml up -d
          
          # Wait for service to be ready
          echo "Waiting for GlobaLeaks to start..."
          timeout 120 bash -c 'until curl -k https://localhost:8443 2>/dev/null; do echo "Waiting..."; sleep 5; done'
          echo "GlobaLeaks is ready!"
          
          # Show container logs for debugging
          docker-compose -f docker-compose.test.yml logs

      - name: Install Cypress dependencies
        run: |
          cd client
          npm install -d

      - name: Run Cypress tests
        run: |
          cd client
          npx cypress run --browser chrome --config baseUrl=https://localhost:8443,chromeWebSecurity=false

      - name: Stop Docker container
        if: always()
        run: |
          cd docker
          docker-compose -f docker-compose.test.yml down || true

      - name: Upload test artifacts
        if: failure()
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3
        with:
          name: cypress-artifacts-${{ matrix.distribution }}
          path: |
            client/cypress/screenshots/
            client/cypress/videos/
